<?xml version="1.0" encoding="UTF-8"?>
<GMA3>
    <Plugin Name="ClawChat" Author="Picoclaw" Version="1.1.2">
        <Component Name="Main" LuaCode="-- ClawChat for grandMA3
-- Version: 1.1.2 (Debug Mode)
-- Author: Picoclaw ðŸ¦ž

local overlayName = &quot;ClawChatOverlay&quot;
-- On utilise un chemin relatif direct pour Ã©viter les soucis de RootPath
local requestFile = &quot;./user_question.json&quot;
local responseFile = &quot;./ai_response.json&quot;

local messages = {}
local uiElements = {}
local lastResponseTime = 0

local function addMessage(sender, text)
    if not text then return end
    table.insert(messages, {sender = sender, text = text})
    if uiElements.scrollContent then
        local label = uiElements.scrollContent:Append(&quot;UILabel&quot;)
        label.Text = &quot;[&quot; .. sender .. &quot;] &quot; .. text
        label.TextAlignH = &quot;Left&quot;
        label.TextColor = (sender == &quot;ME&quot;) and &quot;Global.White&quot; or &quot;Global.Fuchsia&quot;
        label.Height = 30
        uiElements.scrollArea.ScrollV = 10000 
    end
end

local function closeUI()
    local display = GetDisplayByIndex(0)
    local mainOverlay = display:GetMainOverlay()
    local overlay = mainOverlay:Find(overlayName)
    if overlay then 
        mainOverlay:Remove(overlay.Index)
        Printf(&quot;ClawChat: Ancienne interface fermÃ©e.&quot;)
    end
end

local function createUI()
    Printf(&quot;ClawChat: CrÃ©ation de l'interface...&quot;)
    closeUI()
    local display = GetDisplayByIndex(0)
    local mainOverlay = display:GetMainOverlay()
    
    local overlay = mainOverlay:Append(&quot;UIElement&quot;)
    overlay.Name = overlayName
    overlay.H, overlay.W, overlay.X, overlay.Y = 500, 400, 100, 100
    overlay.BackColor = &quot;Global.Black&quot;
    
    local grid = overlay:Append(&quot;UILayoutGrid&quot;)
    grid.Columns, grid.Rows = 1, 2
    grid[1].Height, grid[2].Height = &quot;80%&quot;, &quot;20%&quot;
    
    local scrollArea = grid[1]:Append(&quot;UIScrollArea&quot;)
    uiElements.scrollArea = scrollArea
    
    local scrollContent = scrollArea:Append(&quot;UILayoutGrid&quot;)
    scrollContent.Columns = 1
    uiElements.scrollContent = scrollContent
    
    local bottomGrid = grid[2]:Append(&quot;UILayoutGrid&quot;)
    bottomGrid.Columns, bottomGrid.Rows = 2, 1
    bottomGrid[1].Width, bottomGrid[2].Width = &quot;80%&quot;, &quot;20%&quot;
    
    local input = bottomGrid[1]:Append(&quot;UIInput&quot;)
    input.Text = &quot;&quot;
    uiElements.input = input
    
    local sendBtn = bottomGrid[2]:Append(&quot;UITextButton&quot;)
    sendBtn.Text = &quot;SEND&quot;
    sendBtn.BackColor = &quot;Global.Purple&quot;
    
    sendBtn:SetSignalFunction(&quot;OnClick&quot;, function()
        local text = input.Text
        if text ~= &quot;&quot; then
            addMessage(&quot;ME&quot;, text)
            local file = io.open(requestFile, &quot;w&quot;)
            if file then
                file:write(string.format(&#x27;{&quot;question&quot;: &quot;%s&quot;, &quot;timestamp&quot;: %d}&#x27;, text, os.time()))
                file:close()
                Printf(&quot;ClawChat: Question envoyÃ©e.&quot;)
            else
                Printf(&quot;ClawChat: ERREUR D'Ã‰CRITURE FICHIER !&quot;)
            end
            input.Text = &quot;&quot;
        end
    end)
    
    addMessage(&quot;SYSTEM&quot;, &quot;ClawChat v1.1.2 PrÃªt.&quot;)
    Printf(&quot;ClawChat: Interface affichÃ©e.&quot;)
end

local function main()
    createUI()
    while true do
        local file = io.open(responseFile, &quot;r&quot;)
        if file then
            local content = file:read(&quot;*all&quot;)
            file:close()
            local text = content:match(&#x27;&quot;response&quot;:%s*&quot;([^&quot;]+)&quot;&#x27;)
            local ts = tonumber(content:match(&#x27;&quot;timestamp&quot;:%s*(%d+)&#x27;))
            if text and ts and ts &gt; lastResponseTime then
                lastResponseTime = ts
                addMessage(&quot;CLAW&quot;, text)
            end
        end
        coroutine.yield(0.5)
    end
end

return main" />
    </Plugin>
</GMA3>