<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000000; color: #ffffff; }
        .bg-purple-dark { background-color: #0a0a0a; }
        .border-purple { border-color: #9333ea; }

        /* Mascot Animations */
        @keyframes mascot-blink {
            0%, 90%, 100% { transform: scaleY(1); transform-origin: center; }
            95% { transform: scaleY(0.1); transform-origin: center; }
        }
        @keyframes mascot-look {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-1.5px); }
            75% { transform: translateX(1.5px); }
        }
        @keyframes mascot-float {
            0%, 100% { transform: translateY(0) rotate(0); }
            25% { transform: translateY(-2px) rotate(-1deg); }
            75% { transform: translateY(1px) rotate(1deg); }
        }
        @keyframes mascot-ears-wiggle {
            0%, 100% { transform: skewX(0deg); }
            25% { transform: skewX(-2deg); }
            75% { transform: skewX(2deg); }
        }

        .mascot-wake svg { animation: mascot-float 4s infinite ease-in-out; }
        .mascot-wake .mascot-ears { animation: mascot-ears-wiggle 4s infinite ease-in-out; transform-origin: bottom; transform-box: fill-box; }
        
        .anim-blink .mascot-eyes-group { animation: mascot-blink 4s infinite; }
        .anim-look .mascot-eyes-group { animation: mascot-look 3s infinite ease-in-out; }

        /* Zzz Animation */
        @keyframes zzz-anim {
            0% { transform: translate(0, 0) scale(0.5); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translate(10px, -20px) scale(1.2); opacity: 0; }
        }
        .zzz { opacity: 0; font-family: 'Arial', sans-serif; font-weight: bold; fill: #475569; pointer-events: none; }
        .mascot-sleep .zzz-1 { animation: zzz-anim 3s infinite; }
        .mascot-sleep .zzz-2 { animation: zzz-anim 3s infinite 1s; }
        .mascot-sleep .zzz-3 { animation: zzz-anim 3s infinite 2s; }

        /* Mascot States */
        .mascot-sleep .mascot-eyes { opacity: 0.6; transform: scaleY(0.2); transform-origin: center 18px; transition: all 1s; }
        .mascot-wake .mascot-eyes { opacity: 1; transform: scaleY(1); transition: all 0.3s; }
        .mascot-sleep .mascot-ears { stroke: #000000; transition: all 1s; }
        .mascot-wake .mascot-ears { stroke: #171717; transition: all 0.3s; }

        /* Eye tracking transition */
        .eye-l, .eye-r { transition: transform 0.1s ease-out; }

        /* Stunned State */
        @keyframes spiral-rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .mascot-stunned .mascot-eyes { display: none; }
        .mascot-stunned .mascot-spirals { display: block !important; }
        .mascot-stunned .spiral-path { transform-origin: center; transform-box: fill-box; animation: spiral-rotate 2s infinite linear; }
        
        /* Hit Animation */
        @keyframes mascot-hit-anim {
            0% { transform: scale(1); }
            20% { transform: scale(0.8) translateY(5px); }
            40% { transform: scale(1.1) translateY(-2px); }
            100% { transform: scale(1); }
        }
        .hit-anim { animation: mascot-hit-anim 0.4s cubic-bezier(.36,.07,.19,.97) both; }

        /* Wiggle Animation */
        @keyframes mascot-wiggle {
            0%, 100% { transform: translate(0, 0) rotate(0); }
            25% { transform: translate(-var(--wgl-x), var(--wgl-y)) rotate(calc(-1 * var(--wgl-r))); }
            50% { transform: translate(var(--wgl-x), calc(-1 * var(--wgl-y))) rotate(var(--wgl-r)); }
            75% { transform: translate(calc(-0.5 * var(--wgl-x)), calc(-1 * var(--wgl-y))) rotate(calc(-0.5 * var(--wgl-r))); }
        }
        .mascot-wiggle-active svg { animation: mascot-wiggle 0.1s infinite linear !important; }

        /* Intrigued & Judging Animations */
        @keyframes mascot-intrigued-anim { 0%, 100% { transform: rotate(0deg); } 20%, 80% { transform: rotate(-12deg); } }
        @keyframes mascot-judge-anim { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-3px); } 40%, 80% { transform: translateX(3px); } }
        @keyframes mascot-surprise-anim { 0% { transform: scale(1); } 20% { transform: scale(1.1) translateY(-3px); } 40% { transform: scale(0.9); } 100% { transform: scale(1); } }
        .anim-intrigued svg { animation: mascot-intrigued-anim 2s ease-in-out !important; }
        .anim-judge svg { animation: mascot-judge-anim 0.8s ease-in-out 2 !important; }
        .anim-surprise svg { animation: mascot-surprise-anim 0.4s ease-out !important; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <script>
        if (!localStorage.getItem('currentUser')) window.location.href = 'login.html';
    </script>

    <!-- Header -->
    <div class="max-w-6xl mx-auto flex justify-between items-center mb-8 pl-16 md:pl-24">
        <div class="flex items-center gap-4">
            <div>
                <h1 class="text-3xl font-black tracking-tighter leading-none uppercase">
                    DASHBOARD
                </h1>
                <p id="userWelcome" class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mt-1">Chargement profil...</p>
            </div>
        </div>
        <div class="flex gap-3">
            <a href="/chat" class="bg-white/5 hover:bg-white/10 text-white px-4 py-2 rounded-xl transition-all border border-white/10 text-xs font-bold flex items-center gap-2">
                ü§ñ RETOUR AU CHAT
            </a>
            <button onclick="openSettings()" class="bg-purple-600/10 hover:bg-purple-600/20 text-purple-400 px-4 py-2 rounded-xl transition-all border border-purple-500/20 text-xs font-bold flex items-center gap-2">
                üë§ PROFIL & API
            </button>
            <a href="index.html" class="text-xs bg-white/5 hover:bg-white/10 px-4 py-2 rounded-xl transition-all border border-white/10 flex items-center">
                ‚Üê
            </a>
        </div>
    </div>

    <!-- API Config (Mini) -->
    <div class="max-w-6xl mx-auto mb-8 bg-purple-dark p-6 rounded-2xl border border-white/5 shadow-xl">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            <div class="md:col-span-1">
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">Compte Rentman</label>
                <select id="apiKeySelect" onchange="updateSelectedKey()" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 outline-none transition-all text-sm font-bold">
                    <option value="">S√©lectionnez...</option>
                </select>
            </div>
            <div class="md:col-span-1">
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">Dossier</label>
                <select id="folderSelect" onchange="filterInventory()" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 outline-none transition-all text-sm text-purple-400 font-bold">
                    <option value="">Tous</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">Rechercher</label>
                <input type="text" id="searchInput" oninput="filterInventory()" placeholder="Nom, code, specs..." 
                    class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 outline-none transition-all text-sm">
            </div>
            <div class="md:col-span-1">
                <button onclick="fetchEquipment()" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-black py-3 px-4 rounded-xl transition-all shadow-lg shadow-purple-600/20 uppercase text-xs tracking-widest">
                    Charger
                </button>
            </div>
        </div>
        <div id="statusContainer" class="mt-4 hidden p-3 rounded-xl text-sm bg-black/50 border border-white/5">
            <p id="status" class="text-gray-500 italic"></p>
            <div id="corsHelp" class="hidden mt-2 text-xs text-red-400 leading-relaxed bg-red-500/10 p-3 rounded-lg border border-red-500/20">
                ‚ö†Ô∏è <b>Erreur Proxy :</b> Assurez-vous d'avoir activ√© le proxy dans vos r√©glages de profil et d'avoir cliqu√© sur <b>"Request temporary access"</b> sur <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" class="underline font-bold">cette page</a>.
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="max-w-6xl mx-auto bg-purple-dark rounded-2xl border border-white/5 shadow-xl overflow-hidden mb-10">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-white/5 text-[10px] font-bold uppercase text-gray-500 border-b border-white/5">
                        <th class="px-6 py-4">Mat√©riel</th>
                        <th class="px-6 py-4">Dossier</th>
                        <th class="px-6 py-4">Stock</th>
                        <th class="px-6 py-4">Barcode</th>
                        <th class="px-6 py-4">Code</th>
                    </tr>
                </thead>
                <tbody id="inventoryList" class="divide-y divide-white/5">
                    <tr><td colspan="4" class="px-6 py-20 text-center text-gray-600 italic">S√©lectionnez une cl√© et cliquez sur Charger.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal D√©tails Article -->
    <div id="detailModal" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-4 z-[60]">
        <div class="bg-purple-dark w-full max-w-2xl rounded-3xl border border-purple-500/30 overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <!-- Header Modal -->
            <div class="p-6 border-b border-white/5 flex justify-between items-start bg-gradient-to-br from-purple-600/10 to-transparent">
                <div>
                    <h2 id="modalTitle" class="text-2xl font-black tracking-tighter text-white">NOM DE L'ARTICLE</h2>
                    <p id="modalFolder" class="text-purple-400 text-xs font-bold uppercase tracking-widest mt-1">DOSSIER</p>
                </div>
                <button onclick="closeDetail()" class="bg-white/5 hover:bg-white/10 w-10 h-10 rounded-full flex items-center justify-center transition-all">‚úï</button>
            </div>
            
            <!-- Content Modal -->
            <div class="p-8 overflow-y-auto custom-scrollbar">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Colonne Gauche -->
                    <div class="space-y-6">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">Code Article</label>
                            <p id="modalCode" class="font-mono text-lg text-white bg-black/40 p-3 rounded-xl border border-white/5">CODE-001</p>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">Stock Disponible</label>
                            <div class="flex items-baseline gap-2">
                                <span id="modalStock" class="text-4xl font-black text-purple-500">0</span>
                                <span class="text-gray-500 font-bold uppercase text-[10px]">Unit√©s</span>
                            </div>
                        </div>
                    </div>

                    <!-- Colonne Droite (Specs) -->
                    <div class="bg-black/40 p-6 rounded-2xl border border-white/5 space-y-4">
                        <h3 class="text-[10px] font-bold text-purple-400 uppercase tracking-widest border-b border-purple-500/20 pb-2">QR Code & Sp√©cifications</h3>
                        <div id="modalQrContainer" class="flex justify-center p-4 bg-white rounded-xl mb-4">
                            <img id="modalQrCode" src="" alt="QR Code" class="w-32 h-32">
                        </div>
                        <div id="modalSpecs" class="space-y-3">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                </div>

                <!-- Description / Remarques -->
                <div class="mt-8">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">Remarques internes</label>
                    <div id="modalNotes" class="text-sm text-gray-400 leading-relaxed italic bg-white/5 p-4 rounded-xl border border-white/5 min-h-[60px]">
                        Aucune remarque.
                    </div>
                </div>
            </div>

            <!-- Footer Modal -->
            <div class="p-6 bg-black/50 border-t border-white/5 flex justify-end">
                <button onclick="closeDetail()" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-xl transition-all shadow-lg shadow-purple-600/20">
                    Fermer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Gestion Profil & API -->
    <div id="settingsModal" class="fixed inset-0 bg-black/95 title-bar-blur hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-purple-dark w-full max-w-lg rounded-3xl border border-purple-500/30 overflow-hidden shadow-2xl flex flex-col max-h-[95vh]">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-gradient-to-r from-purple-600/10 to-transparent">
                <h2 class="text-xl font-black tracking-tighter uppercase">R√©glages Profil & API</h2>
                <button onclick="closeSettings()" class="bg-white/5 hover:bg-white/10 w-10 h-10 rounded-full flex items-center justify-center transition-all">‚úï</button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-8">
                <!-- Section Informations Personnelles -->
                <div class="space-y-4">
                    <h3 class="text-[10px] font-bold text-purple-400 uppercase tracking-widest border-b border-purple-500/20 pb-2">Informations Personnelles</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Nom / Pr√©nom</label>
                            <input type="text" id="userNameInput" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm outline-none focus:border-purple-500 transition-all">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Entreprise</label>
                            <input type="text" id="userCompanyInput" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm outline-none focus:border-purple-500 transition-all">
                        </div>
                    </div>
                </div>

                <!-- Section Proxy -->
                <div class="space-y-4">
                    <h3 class="text-[10px] font-bold text-purple-400 uppercase tracking-widest border-b border-purple-500/20 pb-2">Connexion & S√©curit√©</h3>
                    <div class="flex items-center justify-between bg-black/40 p-4 rounded-2xl border border-white/5">
                        <div>
                            <p class="text-sm font-bold text-white">Proxy CORS (CORS-Anywhere)</p>
                            <p class="text-[10px] text-gray-500 uppercase tracking-tighter">Recommand√© pour √©viter les blocages API Rentman</p>
                        </div>
                        <button onclick="toggleProxy()" id="proxyBtn" class="bg-purple-600/20 text-purple-400 px-6 py-2 rounded-xl border border-purple-500/50 text-xs font-black transition-all">
                            PROXY <span id="proxyState">ON</span>
                        </button>
                    </div>
                </div>

                <!-- Section API Keys -->
                <div class="space-y-4">
                    <h3 class="text-[10px] font-bold text-purple-400 uppercase tracking-widest border-b border-purple-500/20 pb-2">Comptes Rentman (Cl√©s API)</h3>
                    
                    <div class="bg-black/40 p-4 rounded-2xl border border-white/5 space-y-4">
                        <div class="grid grid-cols-1 gap-3">
                            <input type="text" id="newKeyName" placeholder="Nom du profil (ex: Impact Vision)" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm outline-none focus:border-purple-500 transition-all">
                            <input type="password" id="newKeyValue" placeholder="Cl√© API Rentman" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm outline-none focus:border-purple-500 transition-all">
                        </div>
                        <button onclick="addApiKey()" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl text-xs uppercase tracking-widest transition-all">
                            Ajouter le compte
                        </button>
                    </div>

                    <div id="keysList" class="space-y-2">
                        <!-- List of keys -->
                    </div>
                </div>
            </div>

            <div class="p-6 bg-black/50 border-t border-white/5 flex gap-3">
                <button onclick="saveProfile()" class="flex-1 bg-white text-black font-black py-3 rounded-xl text-xs uppercase tracking-widest hover:bg-purple-500 hover:text-white transition-all">
                    Enregistrer les modifications
                </button>
            </div>
        </div>
    </div>

    <script>
        let fullInventory = [];
        let useProxy = true;
        let currentUser = localStorage.getItem('currentUser');
        let currentApiKey = "";

        // Initialisation
        window.onload = () => {
            loadProfile();
            updateProxyUI(); // Force UI update on load
        };

        function loadProfile() {
            let userData = JSON.parse(localStorage.getItem(`user_${currentUser}`));
            const welcome = document.getElementById('userWelcome');
            
            if (!userData) {
                welcome.textContent = `Technicien @ Dashboard`;
                return;
            }

            // Migration logic for old API keys
            const oldKey = localStorage.getItem('rentman_api_key');
            if (oldKey && (!userData.apiKeys || userData.apiKeys.length === 0)) {
                if (!userData.apiKeys) userData.apiKeys = [];
                userData.apiKeys.push({ name: "Compte Principal (Migr√©)", value: oldKey });
                localStorage.setItem(`user_${currentUser}`, JSON.stringify(userData));
                localStorage.removeItem('rentman_api_key'); // Clean up
            }

            // Update Header
            welcome.textContent = `${userData.name || 'Technicien'} @ ${userData.company || 'Impact Vision'}`;

            // Update Inputs in Settings
            document.getElementById('userNameInput').value = userData.name || '';
            document.getElementById('userCompanyInput').value = userData.company || '';
            
            // Proxy preference
            if (userData.useProxy !== undefined) {
                useProxy = userData.useProxy;
            }

            // Load API Keys
            loadApiKeys();
        }

        function saveProfile() {
            let userData = JSON.parse(localStorage.getItem(`user_${currentUser}`)) || { apiKeys: [] };
            userData.name = document.getElementById('userNameInput').value;
            userData.company = document.getElementById('userCompanyInput').value;
            userData.useProxy = useProxy;
            
            localStorage.setItem(`user_${currentUser}`, JSON.stringify(userData));
            loadProfile();
            closeSettings();
            
            // Notification visuelle
            const status = document.getElementById('status');
            const statusContainer = document.getElementById('statusContainer');
            statusContainer.classList.remove('hidden');
            status.textContent = "Profil mis √† jour avec succ√®s.";
            status.className = "text-purple-400 font-bold";
            setTimeout(() => statusContainer.classList.add('hidden'), 3000);
        }

        function loadApiKeys() {
            const userData = JSON.parse(localStorage.getItem(`user_${currentUser}`));
            const select = document.getElementById('apiKeySelect');
            const list = document.getElementById('keysList');
            
            select.innerHTML = '<option value="">S√©lectionnez...</option>';
            list.innerHTML = '';

            if (userData && userData.apiKeys) {
                userData.apiKeys.forEach((key, index) => {
                    // Populate select
                    const opt = document.createElement('option');
                    opt.value = key.value;
                    opt.textContent = key.name;
                    select.appendChild(opt);

                    // Populate modal list
                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center bg-black/40 p-3 rounded-xl border border-white/5";
                    item.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-white">${key.name}</span>
                            <span class="text-[8px] text-gray-500 font-mono">CLE: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                        </div>
                        <button onclick="deleteKey(${index})" class="bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white p-2 rounded-lg transition-all text-[10px] uppercase font-bold">
                            Supprimer
                        </button>
                    `;
                    list.appendChild(item);
                });
            }
        }

        function addApiKey() {
            const name = document.getElementById('newKeyName').value;
            const value = document.getElementById('newKeyValue').value;
            if (!name || !value) return alert("Remplissez tous les champs.");

            let userData = JSON.parse(localStorage.getItem(`user_${currentUser}`)) || { apiKeys: [] };
            if (!userData.apiKeys) userData.apiKeys = [];
            
            userData.apiKeys.push({ name, value });
            localStorage.setItem(`user_${currentUser}`, JSON.stringify(userData));
            
            document.getElementById('newKeyName').value = '';
            document.getElementById('newKeyValue').value = '';
            loadApiKeys();
        }

        function deleteKey(index) {
            if (!confirm("Supprimer ce compte Rentman ?")) return;
            let userData = JSON.parse(localStorage.getItem(`user_${currentUser}`));
            userData.apiKeys.splice(index, 1);
            localStorage.setItem(`user_${currentUser}`, JSON.stringify(userData));
            loadApiKeys();
        }

        function updateSelectedKey() {
            currentApiKey = document.getElementById('apiKeySelect').value;
        }

        function openSettings() { document.getElementById('settingsModal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); }

        function toggleProxy() {
            useProxy = !useProxy;
            updateProxyUI();
        }

        function updateProxyUI() {
            const btn = document.getElementById('proxyBtn');
            const state = document.getElementById('proxyState');
            state.textContent = useProxy ? 'ON' : 'OFF';
            
            if (useProxy) {
                btn.className = 'bg-purple-600 text-white px-6 py-2 rounded-xl border border-purple-500/50 text-xs font-black transition-all';
            } else {
                btn.className = 'bg-white/5 text-gray-500 px-6 py-2 rounded-xl border border-white/10 text-xs font-black transition-all';
            }
        }

        function filterInventory() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const selectedFolder = document.getElementById('folderSelect').value;
            
            const filtered = fullInventory.filter(item => {
                const matchesQuery = (item.name && item.name.toLowerCase().includes(query)) || 
                                    (item.code && item.code.toLowerCase().includes(query));
                
                let itemFolder = '-';
                if (item.folder) {
                    itemFolder = typeof item.folder === 'object' ? (item.folder.name || '-') : item.folder;
                }
                
                const matchesFolder = !selectedFolder || itemFolder === selectedFolder;
                
                return matchesQuery && matchesFolder;
            });
            renderItems(filtered);
        }

        function populateFolders(items) {
            const folderSelect = document.getElementById('folderSelect');
            const folders = new Map();
            
            items.forEach(item => {
                if (item.folder) {
                    // Si expand=folder a fonctionn√©, on a un objet avec .name
                    // Sinon, on cherche .folder_name ou on utilise l'ID comme cl√©
                    const folderName = item.folder.name || item.folder_name || item.folder;
                    const folderId = item.folder.id || item.folder;
                    
                    if (folderName && folderName !== '-') {
                        folders.set(folderId, folderName);
                    }
                }
            });

            // Sort folders by name
            const sortedFolders = Array.from(folders.values()).sort();
            
            folderSelect.innerHTML = '<option value="">Tous les dossiers</option>';
            sortedFolders.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                folderSelect.appendChild(opt);
            });
        }

        function renderItems(items) {
            const inventoryList = document.getElementById('inventoryList');
            if (items.length === 0) {
                inventoryList.innerHTML = `<tr><td colspan="4" class="px-6 py-20 text-center text-gray-500 italic">Aucun r√©sultat.</td></tr>`;
                return;
            }
            inventoryList.innerHTML = '';
            items.forEach((item, index) => {
                // Rentman API fields mapping
                const name = item.name || 'N/A';
                const code = item.code || '-';
                
                // Priorit√© √† la quantit√© disponible pour les combinaisons
                const quantity = item.quantity_excluding_reservations_for_combinations ?? 
                                 item.quantity_excluding_reservations ??
                                 item.available_quantity ??
                                 item.quantity ?? 
                                 item.total_quantity ?? 
                                 item.stock_quantity ?? 
                                 item.amount ?? 0;
                
                // Dossier : gestion flexible de l'objet ou de la string
                let folder = '-';
                if (item.folder) {
                    folder = item.folder.name || item.folder_name || (typeof item.folder === 'string' ? item.folder : '-');
                }

                const row = document.createElement('tr');
                row.className = "hover:bg-purple-600/10 cursor-pointer transition-colors border-b border-white/5 last:border-0 group";
                
                row.addEventListener('click', () => {
                    openDetail(item);
                });

                row.innerHTML = `
                    <td class="px-6 py-4 font-bold text-white group-hover:text-purple-400 transition-colors">${name}</td>
                    <td class="px-6 py-4 text-gray-400 text-xs">${folder}</td>
                    <td class="px-6 py-4"><span class="bg-purple-900/30 text-purple-400 px-2 py-1 rounded text-xs font-black border border-purple-500/20">${quantity}</span></td>
                    <td class="px-6 py-4 text-gray-500 font-mono text-[10px]">${item.barcode || '-'}</td>
                    <td class="px-6 py-4 text-gray-500 font-mono text-[10px]">${code}</td>
                `;
                inventoryList.appendChild(row);
            });
        }

        function openDetail(item) {
            document.getElementById('modalTitle').textContent = item.name || 'N/A';
            document.getElementById('modalCode').textContent = item.code || '-';
            
            const barcode = item.barcode || item.code || item.id;
            const qrImg = document.getElementById('modalQrCode');
            qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(barcode)}`;

            const quantity = item.quantity_excluding_reservations_for_combinations ?? 
                             item.quantity_excluding_reservations ??
                             item.available_quantity ??
                             item.quantity ?? 
                             item.total_quantity ?? 
                             item.stock_quantity ?? 
                             item.amount ?? 0;
            document.getElementById('modalStock').textContent = quantity;
            
            let folder = '-';
            if (item.folder) {
                folder = item.folder.name || item.folder_name || (typeof item.folder === 'string' ? item.folder : '-');
            }
            document.getElementById('modalFolder').textContent = folder;
            document.getElementById('modalNotes').textContent = item.remark || item.internal_remark || "Aucune remarque interne renseign√©e.";

            // Specs dynamiques
            const specsContainer = document.getElementById('modalSpecs');
            specsContainer.innerHTML = '';
            
            const specs = [
                { label: 'Barcode', value: item.barcode || item.code },
                { label: 'Poids', value: item.weight ? `${item.weight} kg` : null },
                { label: 'Volume', value: item.volume ? `${item.volume} m¬≥` : null },
                { label: 'Prix Location', value: item.rental_price ? `${item.rental_price} CHF` : null },
                { label: 'Consommation', value: item.power_usage ? `${item.power_usage} W` : null }
            ];

            specs.forEach(spec => {
                if (spec.value) {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center py-2 border-b border-white/5 last:border-0";
                    div.innerHTML = `
                        <span class="text-[10px] text-gray-500 font-bold uppercase">${spec.label}</span>
                        <span class="text-sm font-mono text-white">${spec.value}</span>
                    `;
                    specsContainer.appendChild(div);
                }
            });

            if (specsContainer.innerHTML === '') {
                specsContainer.innerHTML = '<p class="text-xs text-gray-600 italic">Aucune sp√©cification technique disponible.</p>';
            }

            document.getElementById('detailModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Bloque le scroll arri√®re
        }

        function closeDetail() {
            document.getElementById('detailModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function fetchEquipment() {
            if (!currentApiKey) return alert("S√©lectionnez une cl√© API d'abord.");
            
            const status = document.getElementById('status');
            const statusContainer = document.getElementById('statusContainer');
            const corsHelp = document.getElementById('corsHelp');
            const inventoryList = document.getElementById('inventoryList');

            statusContainer.classList.remove('hidden');
            corsHelp.classList.add('hidden');
            status.textContent = "R√©cup√©ration des donn√©es Rentman...";
            inventoryList.innerHTML = `<tr><td colspan="4" class="px-6 py-20 text-center"><div class="animate-spin inline-block w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full"></div></td></tr>`;

            try {
                const authHeader = currentApiKey.includes(' ') ? currentApiKey : `Bearer ${currentApiKey}`;
                let allData = [];
                let offset = 0;
                const limit = 1000;
                let hasMore = true;

                while (hasMore) {
                    status.textContent = `Chargement mat√©riel (${allData.length})...`;
                    let url = `https://api.rentman.net/equipment/?limit=${limit}&offset=${offset}`;
                    if (useProxy) url = 'https://cors-anywhere.herokuapp.com/' + url;

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': authHeader,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`API Error ${response.status}: ${errorText}`);
                    }

                    const data = await response.json();
                    const items = Array.isArray(data) ? data : (data.data || []);
                    allData = allData.concat(items);
                    
                    if (items.length < limit || allData.length >= 15000) {
                        hasMore = false;
                    } else {
                        offset += limit;
                    }
                }

                fullInventory = allData;
                
                if (fullInventory.length === 0) {
                    throw new Error("Aucun √©quipement trouv√©. V√©rifiez votre cl√© API.");
                }

                populateFolders(fullInventory);
                renderItems(fullInventory);
                status.textContent = `${fullInventory.length} articles charg√©s.`;
                status.className = "text-green-500 font-bold";
            } catch (error) {
                console.error("Fetch Error:", error);
                status.textContent = `√âchec: ${error.message}`;
                status.className = "text-red-500 font-bold text-xs";
                
                if (error.message.includes('Failed to fetch') || error.message.includes('400') || error.message.includes('403')) {
                    corsHelp.classList.remove('hidden');
                }
            }
        }
    </script>
    <div class="fixed bottom-4 left-4 text-[10px] font-mono text-gray-700 uppercase tracking-widest opacity-50">v5.7.1-stable</div>
</body>
</html>
    <!-- Global Mascot (Top Left) -->
    <div id="header-mascot" class="fixed top-4 left-4 w-16 h-16 md:w-24 md:h-24 transition-all duration-500 mascot-sleep z-[2000] cursor-pointer">
        <!-- Speech Bubble -->
        <div id="mascot-bubble" class="absolute top-1/2 left-full -translate-y-1/2 ml-[9px] bg-[#0a0a0a]/90 text-purple-600 px-3 py-1.5 rounded-xl text-[10px] font-black shadow-2xl opacity-0 transition-all duration-500 pointer-events-none whitespace-nowrap z-[2001] border-2 border-purple-600">
            <span id="bubble-text"></span>
            <div class="absolute top-1/2 -left-1.5 -translate-y-1/2 w-3 h-3 bg-[#0a0a0a]/90 rotate-45 border-l-2 border-b-2 border-purple-600"></div>
        </div>
        <svg viewBox="0 0 40 40" class="w-full h-full overflow-visible">
            <defs>
                <radialGradient id="mascot-head-grad" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                    <stop offset="0%" stop-color="#262626" />
                    <stop offset="100%" stop-color="#0a0a0a" />
                </radialGradient>
            </defs>
            <path class="mascot-ears" d="M13 12L16 6L19 12" stroke="#171717" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <path class="mascot-ears" d="M27 12L24 6L21 12" stroke="#171717" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="10" y="12" width="20" height="16" rx="2" fill="url(#mascot-head-grad)" stroke="#000000" stroke-width="1.6"/>
            <g class="mascot-eyes mascot-eyes-group">
                <rect id="header-eye-l-fixed" class="eye-l" x="14" y="18" width="3" height="1.5" rx="0.5" fill="#9333ea"/>
                <rect id="header-eye-r-fixed" class="eye-r" x="23" y="18" width="3" height="1.5" rx="0.5" fill="#9333ea"/>
            </g>
            <g class="mascot-spirals" style="display: none;">
                <path class="spiral-path" d="M13.5,18.75 a2,2 0 1,1 4,0 a1.5,1.5 0 1,1 -3,0 a1,1 0 1,1 2,0" fill="none" stroke="#9333ea" stroke-width="0.8" stroke-linecap="round"/>
                <path class="spiral-path" d="M22.5,18.75 a2,2 0 1,1 4,0 a1.5,1.5 0 1,1 -3,0 a1,1 0 1,1 2,0" fill="none" stroke="#9333ea" stroke-width="0.8" stroke-linecap="round"/>
            </g>
            <!-- Zzz elements -->
            <g class="zzz-group">
                <text x="32" y="10" class="zzz zzz-1" font-size="6">Z</text>
                <text x="35" y="5" class="zzz zzz-2" font-size="4">z</text>
                <text x="38" y="0" class="zzz zzz-3" font-size="3">z</text>
            </g>
        </svg>
    </div>

    <script>
        // Mascot Logic
        let mascotSleepTimer;
        let randomBehaviorTimer;
        let mouseX = 0, mouseY = 0, prevMouseX = 0, prevMouseY = 0;
        const bubbleMessages = ["C'est propre !", "T'as v√©rifi√© la NIBT ?", "Impact Vision style ?", "Rigging safe ?", "ImpactFreestyle", "Dashboard power"];

        function setHeaderMascotState(state) {
            const mascot = document.getElementById('header-mascot');
            if (!mascot) return;
            mascot.classList.remove('mascot-stunned', 'anim-intrigued', 'anim-judge', 'anim-surprise'); 
            if (state === 'wake') {
                const wasSleeping = mascot.classList.contains('mascot-sleep');
                mascot.classList.remove('mascot-sleep');
                mascot.classList.add('mascot-wake');
                clearTimeout(mascotSleepTimer);
                mascotSleepTimer = setTimeout(() => setHeaderMascotState('sleep'), 60000); 
                if (wasSleeping) {
                    mascot._behaviorBlocked = true;
                    setTimeout(() => { mascot._behaviorBlocked = false; }, 2000);
                }
                if (!randomBehaviorTimer) triggerRandomBehavior();
            } else {
                mascot.classList.remove('mascot-wake');
                mascot.classList.add('mascot-sleep');
                clearTimeout(randomBehaviorTimer);
                randomBehaviorTimer = null;
            }
        }

        function triggerRandomBehavior() {
            const mascot = document.getElementById('header-mascot');
            if (!mascot || mascot.classList.contains('mascot-sleep') || mascot.classList.contains('mascot-stunned') || mascot.classList.contains('mascot-wiggle-active') || mascot._behaviorBlocked) {
                randomBehaviorTimer = setTimeout(triggerRandomBehavior, 5000 + Math.random() * 10000);
                return;
            }
            const rand = Math.random();
            let animClass = '';
            let duration = 0;
            if (rand < 0.15) { animClass = 'anim-intrigued'; duration = 2000; }
            else if (rand < 0.3) { animClass = 'anim-judge'; duration = 2500; }
            else if (rand < 0.4) { animClass = 'anim-surprise'; duration = 600; }
            if (animClass) {
                mascot.classList.add(animClass);
                setTimeout(() => mascot.classList.remove(animClass), duration);
            }
            randomBehaviorTimer = setTimeout(triggerRandomBehavior, 10000 + Math.random() * 15000);
        }

        function showMascotBubble() {
            const bubble = document.getElementById('mascot-bubble');
            const text = document.getElementById('bubble-text');
            const mascot = document.getElementById('header-mascot');
            if (!mascot || mascot.classList.contains('mascot-sleep')) return;
            text.textContent = bubbleMessages[Math.floor(Math.random() * bubbleMessages.length)];
            bubble.classList.remove('opacity-0');
            bubble.classList.add('opacity-100', 'translate-x-2');
            setTimeout(() => {
                bubble.classList.remove('opacity-100', 'translate-x-2');
                bubble.classList.add('opacity-0');
            }, 3500);
        }

        function updateMascots() {
            const now = Date.now();
            const mouseMoved = mouseX !== prevMouseX || mouseY !== prevMouseY;
            const container = document.getElementById('header-mascot');
            if (!container) return;
            const isSleeping = container.classList.contains('mascot-sleep');
            const isStunned = container.classList.contains('mascot-stunned');
            if (isSleeping || isStunned) {
                container.classList.remove('mascot-wiggle-active');
                ['header-eye-l-fixed', 'header-eye-r-fixed', 'header-eye-l', 'header-eye-r'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.transform = 'translate(0,0)';
                });
            } else {
                const rectContainer = container.getBoundingClientRect();
                const centerX = rectContainer.left + rectContainer.width / 2;
                const centerY = rectContainer.top + rectContainer.height / 2;
                const distToCursor = Math.hypot(mouseX - centerX, mouseY - centerY);
                if (distToCursor < 150 && !container._mustExit) {
                    if (mouseMoved) container._proxStart = now;
                    if (!container._proxStart) container._proxStart = now;
                    const elapsed = now - container._proxStart;
                    let timeFactor = (elapsed > 5000) ? 0 : (elapsed > 3000 ? 1 - ((elapsed - 3000) / 2000) : 1);
                    if (timeFactor > 0) {
                        container.classList.add('mascot-wiggle-active');
                        let intensity = Math.pow(1 - (distToCursor / 150), 1.5) * timeFactor;
                        container.style.setProperty('--wgl-x', (3.5 * intensity) + 'px');
                        container.style.setProperty('--wgl-y', (1.75 * intensity) + 'px');
                        container.style.setProperty('--wgl-r', (6 * intensity) + 'deg');
                    } else { container.classList.remove('mascot-wiggle-active'); container._mustExit = true; }
                } else {
                    container._proxStart = null;
                    if (distToCursor >= 150) container._mustExit = false;
                    container.classList.remove('mascot-wiggle-active');
                }
                const svg = container.querySelector('svg');
                const rect = svg.getBoundingClientRect();
                
                // Eyes tracking (both header and fixed)
                [{id:'header-eye-l-fixed', cx:15.5}, {id:'header-eye-r-fixed', cx:24.5}, {id:'header-eye-l', cx:15.5}, {id:'header-eye-r', cx:24.5}].forEach(eye => {
                    const el = document.getElementById(eye.id);
                    if (!el) return;
                    const dx = mouseX - (rect.left + (eye.cx / 40) * rect.width);
                    const dy = mouseY - (rect.top + (18.75 / 40) * rect.height);
                    const angle = Math.atan2(dy, dx);
                    const dist = Math.min(1.5, Math.hypot(dx, dy) / 40);
                    el.style.transform = `translate(${Math.cos(angle) * dist}px, ${Math.sin(angle) * dist}px)`;
                });
            }
            prevMouseX = mouseX; prevMouseY = mouseY;
            requestAnimationFrame(updateMascots);
        }

        // Init Mascot
        document.addEventListener('mousemove', (e) => { mouseX = e.clientX; mouseY = e.clientY; });
        document.addEventListener('mousedown', () => setHeaderMascotState('wake'));
        setInterval(() => { if (Math.random() < 0.3) showMascotBubble(); }, 12000);
        const mascot = document.getElementById('header-mascot');
        if (mascot) {
            mascot.addEventListener('click', () => {
                mascot.classList.remove('hit-anim', 'anim-intrigued', 'anim-judge');
                void mascot.offsetWidth;
                mascot.classList.add('hit-anim');
                if (mascot.classList.contains('mascot-sleep')) setHeaderMascotState('wake');
                else if (!mascot.classList.contains('mascot-stunned')) {
                    mascot.classList.add('mascot-stunned');
                    setTimeout(() => mascot.classList.remove('mascot-stunned'), 3000);
                }
            });
        }
        requestAnimationFrame(updateMascots);
    </script>